# Session Context - Homelab Notebook

**Last Updated:** 2025-12-03
**Session Purpose:** Authentication & Infrastructure Cleanup

---

## Workflow Progress

| Phase | Status | Notes |
|-------|--------|-------|
| Project Brief v2 | COMPLETE | .docs/homelab-notebook-brief-v1.md |
| UI/UX Redesign | COMPLETE | .docs/ui-ux-redesign-v2.md |
| Migration Phase 1-6 | COMPLETE | Core structure, features, polish |
| App Init Fix | COMPLETE | Fixed SSR hydration blocking issue |
| UI Refresh | COMPLETE | Notion-inspired sidebar layout with mobile support |
| Deployment Strategy | COMPLETE | .docs/deployment-strategy-updated.md |
| Dependency Fix | COMPLETE | Resolved vite version conflict |
| File Attachments | COMPLETE | Components ready, PocketBase field added |
| Search Relocation | COMPLETE | Moved to Header center |
| Carta Editor | COMPLETE | Merged to main |
| Fly.io Deployment | COMPLETE | Live at homelab-notebook.fly.dev |
| CI/CD Pipeline | COMPLETE | GitHub Actions â†’ Fly.io auto-deploy |
| Type Error Fixes | COMPLETE | All TypeScript/Svelte errors resolved |
| **Authentication** | **COMPLETE** | Login page, server-side guards, logout |
| **PocketBase Migration** | **COMPLETE** | Collections on Fly.io PocketBase |
| **Infrastructure Cleanup** | **COMPLETE** | Removed VPS references |
| **Tigris Storage** | **PENDING** | Required for persistent file attachments |

**Mode:** DELIVERY (practical utility focus)

---

## Current State

### Latest Session (2025-12-03) - Authentication & Infrastructure

#### Completed
1. **Authentication Implementation**
   - Created `/login` page with email/password form
   - Added `hooks.server.ts` for server-side auth guards
   - Created auth store (`src/lib/stores/auth.ts`)
   - Added logout button to sidebar
   - All routes now require authentication

2. **PocketBase Migration to Fly.io**
   - Created `entries`, `projects`, `tags` collections on `proposaltracker-api`
   - Set API rules (`@request.auth.id != ""`) for all collections
   - Shared user account works across apps (SSO with proposaltracker)

3. **Infrastructure Cleanup**
   - Updated CLAUDE.md with correct Fly.io URLs
   - Fixed Dockerfile default PocketBase URL
   - Fixed CI workflow PocketBase URL
   - Updated .env.local for local development
   - Deleted outdated `.docs/pocketbase-security-setup.md`
   - Cleaned build artifacts with old references

#### Files Created
- `src/routes/login/+page.svelte` - Login page
- `src/routes/login/+layout.svelte` - Standalone layout for login
- `src/hooks.server.ts` - Server-side auth guard
- `src/app.d.ts` - TypeScript types for locals
- `src/lib/stores/auth.ts` - Auth state management
- `.docs/pocketbase-flyio-setup.md` - Collection setup guide

#### Files Modified
- `src/lib/stores/index.ts` - Export auth store
- `src/lib/components/layout/Sidebar.svelte` - Added logout button
- `CLAUDE.md` - Updated infrastructure section
- `Dockerfile` - Updated default PocketBase URL
- `.github/workflows/ci.yml` - Updated PocketBase URL
- `.env.local` - Updated for local dev

---

## Configuration

### Production (Fly.io)
- **App URL:** https://homelab-notebook.fly.dev
- **Custom Domain:** https://homelab-notebook.haugaard.app
- **PocketBase API:** http://proposaltracker-api.internal:8080 (internal)
- **PocketBase Admin:** https://proposaltracker-api.fly.dev/_/
- **Region:** sjc (San Jose)
- **VM:** shared-cpu-1x, 512MB RAM
- **Auto-deploy:** On push to `main` via GitHub Actions

### Shared PocketBase Instance
- `proposaltracker-api` serves multiple apps
- User accounts shared (SSO)
- Collections per app: `entries`, `projects`, `tags` (homelab-notebook)

### CI/CD (GitHub Actions)
- **CI Trigger:** Push to `main`/`dev`, PRs to `main`
- **Deploy Trigger:** After CI succeeds on `main`
- **Secrets Required:** `FLY_API_TOKEN`

### Local Development
- **PocketBase:** `http://localhost:8090` (Docker container)
- **ENV:** `PUBLIC_POCKETBASE_URL=http://localhost:8090` in `.env.local`

---

## Quick Commands

```bash
# Local development
pnpm dev

# Run checks
pnpm lint          # ESLint
pnpm check         # TypeScript/Svelte
pnpm test          # Vitest
pnpm build         # Production build

# Deploy (manual - usually auto via CI/CD)
fly deploy

# Check CI/CD status
gh run list --limit 5

# View Fly.io logs
fly logs

# PocketBase admin
open https://proposaltracker-api.fly.dev/_/
```

---

## Critical Next Action

### Configure Tigris Storage (REQUIRED)

File attachments are currently stored on ephemeral Fly.io VM storage. They will be **lost on redeploy**.

**Before uploading any attachments:**
1. Create Tigris bucket: `fly storage create`
2. Configure PocketBase S3 settings in admin UI
3. Set Fly secrets for S3 credentials

See `.docs/deployment-strategy-updated.md` lines 224-282 for details.

---

## Reference Files

- `.github/workflows/ci.yml` - CI pipeline
- `.github/workflows/deploy.yml` - CD pipeline
- `CICD-SECRETS.md` - Secrets documentation
- `.docs/deployment-log.md` - Deployment runbook
- `.docs/pocketbase-flyio-setup.md` - Collection setup guide
- `.docs/deployment-strategy-updated.md` - Full deployment strategy
- `fly.toml` - Fly.io configuration
- `CLAUDE.md` - Project documentation
